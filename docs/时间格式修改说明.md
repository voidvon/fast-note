# 时间格式修改说明

## 修改概述

将项目中所有时间格式从 ISO 8601 标准格式（使用 `T` 分隔）改为使用空格分隔的格式。

### 修改前
```
2026-02-11T10:30:45.123Z
```

### 修改后
```
2026-02-11 10:30:45.123Z
```

## 修改原因

某些数据库系统不支持 `T` 分隔的 ISO 8601 格式，使用空格分隔可以提高兼容性。

## 修改文件清单

### 核心文件（2个）

1. **src/utils/date.ts**
   - 修改 `getTime()` 函数
   - 添加 `.replace('T', ' ')` 转换

2. **src/database/sync.ts**
   - 修改 `getCurrentTime()` 函数
   - 添加 `.replace('T', ' ')` 转换

### 适配器文件（1个）

3. **src/adapters/pocketbase/auth-adapter.ts**
   - 修改所有 fallback 时间生成（5处）
   - 包括：signIn、signUp、getCurrentUser、getCurrentAuthUser、onAuthChange

### Store 文件（2个）

4. **src/stores/notes.ts**
   - 修改 `getDeletedNotes()` 中的 30 天前时间计算

5. **src/stores/publicNotes.ts**
   - 修改 `getDeletedPublicNotes()` 中的 30 天前时间计算

### 组件文件（1个）

6. **src/components/LongPressMenu.vue**
   - 修改永久删除时的特殊时间戳（epoch time）

## 技术验证

### 兼容性测试

✅ **字符串比较** - 字典序与时间顺序一致
```javascript
"2026-02-11 10:30:45.123Z" > "2026-02-11 09:30:45.123Z"  // true
```

✅ **JavaScript Date 解析** - 两种格式都能正确解析
```javascript
new Date("2026-02-11 10:30:45.123Z")  // 有效
```

✅ **时间戳比较** - getTime() 比较正常工作
```javascript
new Date("2026-02-11 10:30:45.123Z").getTime()  // 正常
```

✅ **排序功能** - 数组排序正常工作
```javascript
times.sort()  // 按时间顺序排序
```

### 构建测试

```bash
npm run build
```

✅ TypeScript 类型检查通过
✅ Vite 构建成功
✅ 无错误和警告

## 影响范围

### 不受影响的部分

- ✅ 所有使用 `getTime()` 的代码（约 30+ 处）
- ✅ 所有时间比较逻辑（字符串和时间戳比较）
- ✅ PocketBase 查询过滤器
- ✅ IndexedDB 存储和查询
- ✅ 排序和过滤功能

### 需要注意的部分

⚠️ **现有数据**
- 数据库中已存在的数据仍使用旧格式（带 T）
- 新数据使用新格式（带空格）
- 两种格式可以共存，字符串比较仍然有效

⚠️ **PocketBase 返回数据**
- PocketBase SDK 返回的时间可能仍是标准 ISO 8601 格式
- 在 `authData.record.created` 和 `authData.record.updated` 中使用 fallback 处理

## 数据迁移建议

### 选项 1：不迁移（推荐）
- 新旧格式可以共存
- 字符串比较仍然有效
- 无需额外操作

### 选项 2：清空本地数据库
```javascript
// 在浏览器控制台执行
await db.notes.clear()
await db.note_files.clear()
// 然后重新同步
```

### 选项 3：批量转换（可选）
```javascript
// 转换所有笔记的时间格式
const notes = await db.notes.toArray()
for (const note of notes) {
  note.created = note.created.replace('T', ' ')
  note.updated = note.updated.replace('T', ' ')
  await db.notes.put(note)
}
```

## 测试建议

1. **本地测试**
   - 创建新笔记，检查时间格式
   - 编辑笔记，检查更新时间
   - 测试排序功能
   - 测试搜索功能

2. **同步测试**
   - 测试与 PocketBase 的同步
   - 测试多设备同步
   - 测试冲突解决

3. **回收站测试**
   - 测试删除笔记
   - 测试 30 天自动清理

## 回滚方案

如果需要回滚，只需将所有 `.replace('T', ' ')` 移除即可：

```javascript
// 回滚前
return new Date().toISOString().replace('T', ' ')

// 回滚后
return new Date().toISOString()
```

## 总结

- ✅ 修改完成，共涉及 6 个文件
- ✅ 构建测试通过
- ✅ 兼容性验证通过
- ✅ 新旧格式可以共存
- ⚠️ 建议在开发环境充分测试后再部署到生产环境
